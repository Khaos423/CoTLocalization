name: Check Game Update

on:
  workflow_dispatch:
    inputs:
      game_type:
        description: 'æ¸¸æˆç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'ea'
        type: choice
        options:
          - ea
          - stable
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡

jobs:
  check_update:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      version: ${{ steps.check.outputs.version }}
      upload_id: ${{ steps.check.outputs.upload_id }}
      build_id: ${{ steps.check.outputs.build_id }}
      game_type: ${{ steps.check.outputs.game_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Restore version cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .version_cache
          key: game-version-cache-${{ github.event.inputs.game_type || 'ea' }}
          restore-keys: |
            game-version-cache-

      - name: Check for updates
        id: check
        env:
          GAME_TYPE: ${{ github.event.inputs.game_type || 'ea' }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
          ITCH_API_KEY: ${{ secrets.ITCH_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import json
          import requests

          # é…ç½®
          STABLE_GAME_ID = "2151565"
          EA_GAME_ID = "2499529"
          UPLOADS_URL = "https://api.itch.io/games/{game_id}/uploads"
          API_KEY = os.environ.get("ITCH_API_KEY", "")

          game_type = os.environ.get("GAME_TYPE", "ea")
          force_update = os.environ.get("FORCE_UPDATE", "false").lower() == "true"
          game_id = EA_GAME_ID if game_type == "ea" else STABLE_GAME_ID

          print(f"æ£€æŸ¥æ¸¸æˆæ›´æ–°: {game_type} (game_id: {game_id})")
          if force_update:
              print("âš ï¸ å¼ºåˆ¶æ›´æ–°æ¨¡å¼å·²å¯ç”¨")

          # è·å–ä¸Šä¼ åˆ—è¡¨
          url = UPLOADS_URL.format(game_id=game_id)
          headers = {"Authorization": API_KEY} if API_KEY else {}
          response = requests.get(url, headers=headers)
          response.raise_for_status()
          data = response.json()

          # æŸ¥æ‰¾HTML channel
          html_upload = None
          for upload in data.get("uploads", []):
              if upload.get("channel_name") == "html":
                  html_upload = upload
                  break

          if not html_upload:
              print("æœªæ‰¾åˆ°HTML channel")
              exit(1)

          upload_id = html_upload.get("id")
          build_info = html_upload.get("build", {})
          build_id = build_info.get("id")
          version = build_info.get("user_version", str(build_info.get("version", "unknown")))

          print(f"Upload ID: {upload_id}")
          print(f"Build ID: {build_id}")
          print(f"Version: {version}")

          # ç‰ˆæœ¬ç¼“å­˜æ–‡ä»¶
          os.makedirs(".version_cache", exist_ok=True)
          version_file = f".version_cache/last_version_{game_type}.json"
          
          # è¯»å–ä¸Šæ¬¡ç¼“å­˜çš„ç‰ˆæœ¬
          last_version = None
          last_build_id = None
          if os.path.exists(version_file):
              try:
                  with open(version_file, "r") as f:
                      cached = json.load(f)
                      last_version = cached.get("version")
                      last_build_id = cached.get("build_id")
                  print(f"ä¸Šæ¬¡ç¼“å­˜ç‰ˆæœ¬: {last_version} (build_id: {last_build_id})")
              except Exception as e:
                  print(f"è¯»å–ç¼“å­˜å¤±è´¥: {e}")

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
          has_update = "false"
          if force_update:
              has_update = "true"
              print("âœ… å¼ºåˆ¶æ›´æ–°")
          elif last_build_id is None:
              has_update = "true"
              print("âœ… é¦–æ¬¡è¿è¡Œï¼Œéœ€è¦æ›´æ–°")
          elif str(build_id) != str(last_build_id):
              has_update = "true"
              print(f"âœ… æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: {last_version} -> {version}")
          else:
              print(f"â„¹ï¸ ç‰ˆæœ¬æœªå˜åŒ–: {version}")

          # ä¿å­˜å½“å‰ç‰ˆæœ¬åˆ°ç¼“å­˜
          with open(version_file, "w") as f:
              json.dump({
                  "version": version,
                  "build_id": build_id,
                  "upload_id": upload_id
              }, f)
          print(f"ç‰ˆæœ¬ä¿¡æ¯å·²ç¼“å­˜åˆ°: {version_file}")
          
          # è¾“å‡ºåˆ°GitHub Actions
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"has_update={has_update}\n")
              f.write(f"version={version}\n")
              f.write(f"upload_id={upload_id}\n")
              f.write(f"build_id={build_id}\n")
              f.write(f"game_type={game_type}\n")
          
          print(f"\n{'ğŸš€ å°†æ‰§è¡Œæ›´æ–°' if has_update == 'true' else 'â­ï¸ è·³è¿‡æ›´æ–°'}")
          EOF

      - name: Save version cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .version_cache
          key: game-version-cache-${{ github.event.inputs.game_type || 'ea' }}-${{ github.run_id }}

  download_and_export:
    needs: check_update
    if: needs.check_update.outputs.has_update == 'true'
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.check_update.outputs.version }}
      UPLOAD_ID: ${{ needs.check_update.outputs.upload_id }}
      BUILD_ID: ${{ needs.check_update.outputs.build_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests selenium webdriver-manager

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest

      - name: Download HTML file
        run: |
          python << 'EOF'
          import os
          import requests

          upload_id = os.environ["UPLOAD_ID"]
          build_id = os.environ["BUILD_ID"]
          version = os.environ["VERSION"]

          html_url = f"https://html-classic.itch.zone/html/{upload_id}-{build_id}/index.html"
          print(f"ä¸‹è½½HTML: {html_url}")

          response = requests.get(html_url, stream=True)
          response.raise_for_status()

          os.makedirs("temp_update_files", exist_ok=True)
          html_path = f"temp_update_files/index{version}.html"
          
          with open(html_path, "wb") as f:
              for chunk in response.iter_content(chunk_size=8192):
                  f.write(chunk)
          
          print(f"HTMLå·²ä¿å­˜åˆ°: {html_path}")
          
          # ä¿å­˜è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"HTML_PATH={os.path.abspath(html_path)}\n")
          EOF

      - name: Export story data
        run: |
          python << 'EOF'
          import os
          import time
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service as ChromeService
          from webdriver_manager.chrome import ChromeDriverManager
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC

          html_path = os.environ["HTML_PATH"]
          version = os.environ["VERSION"]
          
          # æ£€æŸ¥story-export.jsæ˜¯å¦å­˜åœ¨
          js_path = "story-export.js"
          if not os.path.exists(js_path):
              print(f"è­¦å‘Š: {js_path} ä¸å­˜åœ¨ï¼Œè·³è¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æ­¥éª¤")
              print("è¯·ç¡®ä¿story-export.jsæ–‡ä»¶å·²æ·»åŠ åˆ°ä»“åº“ä¸­")
              exit(0)

          # é…ç½®Chrome headless
          options = webdriver.ChromeOptions()
          options.add_argument("--headless=new")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("--disable-gpu")
          
          download_dir = os.path.abspath(".")
          prefs = {
              "download.default_directory": download_dir,
              "download.prompt_for_download": False,
              "download.directory_upgrade": True,
              "safebrowsing.enabled": True
          }
          options.add_experimental_option("prefs", prefs)

          driver = None
          try:
              service = ChromeService(ChromeDriverManager().install())
              driver = webdriver.Chrome(service=service, options=options)
              
              # headlessæ¨¡å¼ä¸‹è®¾ç½®ä¸‹è½½è¡Œä¸º
              driver.execute_cdp_cmd("Page.setDownloadBehavior", {
                  "behavior": "allow",
                  "downloadPath": download_dir
              })
              
              driver.get("file://" + html_path)
              
              WebDriverWait(driver, 10).until(
                  EC.presence_of_element_located((By.TAG_NAME, "body"))
              )
              print("é¡µé¢å·²åŠ è½½")

              with open(js_path, "r", encoding="utf-8") as f:
                  js_code = f.read()
              
              print("æ‰§è¡Œå¯¼å‡ºè„šæœ¬...")
              driver.execute_script(js_code)
              
              # ç­‰å¾…ä¸‹è½½å®Œæˆ
              zip_path = os.path.join(download_dir, "story_export.zip")
              timeout = 60
              start_time = time.time()
              while not os.path.exists(zip_path):
                  time.sleep(1)
                  if time.time() - start_time > timeout:
                      print("ä¸‹è½½è¶…æ—¶")
                      exit(1)
              
              print(f"å¯¼å‡ºå®Œæˆ: {zip_path}")

          except Exception as e:
              print(f"é”™è¯¯: {e}")
              exit(1)
          finally:
              if driver:
                  driver.quit()
          EOF

      - name: Upload HTML artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-html-${{ env.VERSION }}
          path: temp_update_files/*.html
          if-no-files-found: warn

      - name: Upload story export artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: story-export-${{ env.VERSION }}
          path: story_export.zip
          if-no-files-found: warn