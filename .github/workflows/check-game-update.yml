name: Check Game Update

on:
  workflow_dispatch:
    inputs:
      game_type:
        description: 'Ê∏∏ÊàèÁâàÊú¨Á±ªÂûã'
        required: true
        default: 'stable'
        type: choice
        options:
          - ea
          - stable
      ea_password:
        description: 'EAÁâàÂØÜÁ†ÅÔºà‰ªÖEAÁâàÈúÄË¶ÅÔºâ'
        required: false
        type: string
      force_update:
        description: 'Âº∫Âà∂Êõ¥Êñ∞ÔºàÂøΩÁï•ÁâàÊú¨ÁºìÂ≠òÔºâ'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # ÊØè6Â∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°Ôºà‰ªÖÊ£ÄÊü•Á®≥ÂÆöÁâàÔºâ

jobs:
  check_update:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      version: ${{ steps.check.outputs.version }}
      upload_id: ${{ steps.check.outputs.upload_id }}
      build_id: ${{ steps.check.outputs.build_id }}
      game_type: ${{ steps.check.outputs.game_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Restore version cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .version_cache
          key: game-version-cache-${{ github.event.inputs.game_type || 'stable' }}
          restore-keys: |
            game-version-cache-

      - name: Check for updates
        id: check
        env:
          GAME_TYPE: ${{ github.event.inputs.game_type || 'stable' }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
          ITCH_API_KEY: ${{ secrets.ITCH_API_KEY }}
          EA_PASSWORD: ${{ github.event.inputs.ea_password }}
        run: |
          python << 'EOF'
          import os
          import json
          import requests

          # ÈÖçÁΩÆ
          STABLE_GAME_ID = "2151565"
          EA_GAME_ID = "2499529"
          UPLOADS_URL = "https://api.itch.io/games/{game_id}/uploads"
          API_KEY = os.environ.get("ITCH_API_KEY", "")
          EA_PASSWORD = os.environ.get("EA_PASSWORD", "")

          game_type = os.environ.get("GAME_TYPE", "stable")
          force_update = os.environ.get("FORCE_UPDATE", "false").lower() == "true"
          game_id = EA_GAME_ID if game_type == "ea" else STABLE_GAME_ID

          print(f"Ê£ÄÊü•Ê∏∏ÊàèÊõ¥Êñ∞: {game_type} (game_id: {game_id})")
          if force_update:
              print("‚ö†Ô∏è Âº∫Âà∂Êõ¥Êñ∞Ê®°ÂºèÂ∑≤ÂêØÁî®")

          if not API_KEY:
              print("‚ö†Ô∏è Ë≠¶Âëä: ITCH_API_KEYÊú™ËÆæÁΩÆ")
          
          if game_type == "ea" and not EA_PASSWORD:
              print("‚ùå ÈîôËØØ: EAÁâàÈúÄË¶ÅÊèê‰æõÂØÜÁ†Å")
              exit(1)

          # Ëé∑Âèñ‰∏ä‰º†ÂàóË°® - ‰ΩøÁî®HeaderËÆ§ËØÅ
          url = UPLOADS_URL.format(game_id=game_id)
          headers = {"Authorization": API_KEY} if API_KEY else {}
          params = {"password": EA_PASSWORD} if game_type == "ea" and EA_PASSWORD else {}
          
          response = requests.get(url, headers=headers, params=params)
          response.raise_for_status()
          data = response.json()

          # Êü•ÊâæHTML channel
          html_upload = None
          for upload in data.get("uploads", []):
              if upload.get("channel_name") == "html":
                  html_upload = upload
                  break

          if not html_upload:
              print("Êú™ÊâæÂà∞HTML channel")
              exit(1)

          upload_id = html_upload.get("id")
          build_info = html_upload.get("build", {})
          build_id = build_info.get("id")
          version = build_info.get("user_version", str(build_info.get("version", "unknown")))

          print(f"Upload ID: {upload_id}")
          print(f"Build ID: {build_id}")
          print(f"Version: {version}")

          # ÁâàÊú¨ÁºìÂ≠òÊñá‰ª∂
          os.makedirs(".version_cache", exist_ok=True)
          version_file = f".version_cache/last_version_{game_type}.json"
          
          # ËØªÂèñ‰∏äÊ¨°ÁºìÂ≠òÁöÑÁâàÊú¨
          last_version = None
          last_build_id = None
          if os.path.exists(version_file):
              try:
                  with open(version_file, "r") as f:
                      cached = json.load(f)
                      last_version = cached.get("version")
                      last_build_id = cached.get("build_id")
                  print(f"‰∏äÊ¨°ÁºìÂ≠òÁâàÊú¨: {last_version} (build_id: {last_build_id})")
              except Exception as e:
                  print(f"ËØªÂèñÁºìÂ≠òÂ§±Ë¥•: {e}")

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁâàÊú¨
          has_update = "false"
          if force_update:
              has_update = "true"
              print("‚úÖ Âº∫Âà∂Êõ¥Êñ∞")
          elif last_build_id is None:
              has_update = "true"
              print("‚úÖ È¶ñÊ¨°ËøêË°åÔºåÈúÄË¶ÅÊõ¥Êñ∞")
          elif str(build_id) != str(last_build_id):
              has_update = "true"
              print(f"‚úÖ Ê£ÄÊµãÂà∞Êñ∞ÁâàÊú¨: {last_version} -> {version}")
          else:
              print(f"‚ÑπÔ∏è ÁâàÊú¨Êú™ÂèòÂåñ: {version}")

          # ‰øùÂ≠òÂΩìÂâçÁâàÊú¨Âà∞ÁºìÂ≠ò
          with open(version_file, "w") as f:
              json.dump({
                  "version": version,
                  "build_id": build_id,
                  "upload_id": upload_id
              }, f)
          print(f"ÁâàÊú¨‰ø°ÊÅØÂ∑≤ÁºìÂ≠òÂà∞: {version_file}")
          
          # ËæìÂá∫Âà∞GitHub Actions
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"has_update={has_update}\n")
              f.write(f"version={version}\n")
              f.write(f"upload_id={upload_id}\n")
              f.write(f"build_id={build_id}\n")
              f.write(f"game_type={game_type}\n")
          
          print(f"\n{'üöÄ Â∞ÜÊâßË°åÊõ¥Êñ∞' if has_update == 'true' else '‚è≠Ô∏è Ë∑≥ËøáÊõ¥Êñ∞'}")
          EOF

      - name: Save version cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .version_cache
          key: game-version-cache-${{ github.event.inputs.game_type || 'ea' }}-${{ github.run_id }}

  download_and_export:
    needs: check_update
    if: needs.check_update.outputs.has_update == 'true'
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.check_update.outputs.version }}
      UPLOAD_ID: ${{ needs.check_update.outputs.upload_id }}
      BUILD_ID: ${{ needs.check_update.outputs.build_id }}
      PYTHONIOENCODING: utf-8
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests selenium webdriver-manager

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest

      - name: Download HTML file
        shell: bash
        run: |
          python << 'EOF'
          import os
          import requests

          upload_id = os.environ["UPLOAD_ID"]
          build_id = os.environ["BUILD_ID"]
          version = os.environ["VERSION"]

          html_url = f"https://html-classic.itch.zone/html/{upload_id}-{build_id}/index.html"
          print(f"‰∏ãËΩΩHTML: {html_url}")

          response = requests.get(html_url, stream=True)
          response.raise_for_status()

          os.makedirs("temp_update_files", exist_ok=True)
          html_path = f"temp_update_files/index{version}.html"
          
          with open(html_path, "wb") as f:
              for chunk in response.iter_content(chunk_size=8192):
                  f.write(chunk)
          
          print(f"HTMLÂ∑≤‰øùÂ≠òÂà∞: {html_path}")
          
          # ‰øùÂ≠òË∑ØÂæÑ‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®
          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"HTML_PATH={os.path.abspath(html_path)}\n")
          EOF

      - name: Export story data
        shell: bash
        run: |
          python << 'EOF'
          import os
          import time
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service as ChromeService
          from webdriver_manager.chrome import ChromeDriverManager
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC

          html_path = os.environ["HTML_PATH"]
          version = os.environ["VERSION"]
          
          # Ê£ÄÊü•story-export.jsÊòØÂê¶Â≠òÂú®
          js_path = "story-export.js"
          if not os.path.exists(js_path):
              print(f"Ë≠¶Âëä: {js_path} ‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊµèËßàÂô®Ëá™Âä®ÂåñÊ≠•È™§")
              print("ËØ∑Á°Æ‰øùstory-export.jsÊñá‰ª∂Â∑≤Ê∑ªÂä†Âà∞‰ªìÂ∫ì‰∏≠")
              exit(0)

          # ÈÖçÁΩÆChrome headless
          options = webdriver.ChromeOptions()
          options.add_argument("--headless=new")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("--disable-gpu")
          
          download_dir = os.path.abspath(".")
          prefs = {
              "download.default_directory": download_dir,
              "download.prompt_for_download": False,
              "download.directory_upgrade": True,
              "safebrowsing.enabled": True
          }
          options.add_experimental_option("prefs", prefs)

          driver = None
          try:
              service = ChromeService(ChromeDriverManager().install())
              driver = webdriver.Chrome(service=service, options=options)
              
              # headlessÊ®°Âºè‰∏ãËÆæÁΩÆ‰∏ãËΩΩË°å‰∏∫
              driver.execute_cdp_cmd("Page.setDownloadBehavior", {
                  "behavior": "allow",
                  "downloadPath": download_dir
              })
              
              driver.get("file://" + html_path)
              
              WebDriverWait(driver, 10).until(
                  EC.presence_of_element_located((By.TAG_NAME, "body"))
              )
              print("È°µÈù¢Â∑≤Âä†ËΩΩ")

              with open(js_path, "r", encoding="utf-8") as f:
                  js_code = f.read()
              
              print("ÊâßË°åÂØºÂá∫ËÑöÊú¨...")
              driver.execute_script(js_code)
              
              # Á≠âÂæÖ‰∏ãËΩΩÂÆåÊàê
              zip_path = os.path.join(download_dir, "story_export.zip")
              timeout = 60
              start_time = time.time()
              while not os.path.exists(zip_path):
                  time.sleep(1)
                  if time.time() - start_time > timeout:
                      print("‰∏ãËΩΩË∂ÖÊó∂")
                      exit(1)
              
              print(f"ÂØºÂá∫ÂÆåÊàê: {zip_path}")

          except Exception as e:
              print(f"ÈîôËØØ: {e}")
              exit(1)
          finally:
              if driver:
                  driver.quit()
          EOF

      - name: Upload HTML artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-html-${{ env.VERSION }}
          path: temp_update_files/*.html
          if-no-files-found: warn

      - name: Upload story export artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: story-export-${{ env.VERSION }}
          path: story_export.zip
          if-no-files-found: warn

  inject_modloader:
    needs: [check_update, download_and_export]
    if: needs.check_update.outputs.has_update == 'true'
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.check_update.outputs.version }}
      PYTHONIOENCODING: utf-8
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: game-html-${{ env.VERSION }}
          path: game-html

      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download ModLoader Package from workflow artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: Lyoko-Jeremie/sugarcube-2-ModLoader
          workflow: Build-ModLoader-Package.yml
          workflow_conclusion: success
          name: ModLoader Package
          path: modloader-download
          search_artifacts: true

      - name: Extract ModLoader Package
        shell: pwsh
        run: |
          Write-Host "Downloaded files:"
          Get-ChildItem -Path "modloader-download" -Recurse
          
          # Êü•ÊâæzipÊñá‰ª∂
          $zipFile = Get-ChildItem -Path "modloader-download" -Filter "*.zip" -Recurse | Select-Object -First 1
          if ($zipFile) {
            Write-Host "Extracting: $($zipFile.FullName)"
            Expand-Archive -Path $zipFile.FullName -DestinationPath "ModLoader" -Force
          } else {
            # Â¶ÇÊûúÊ≤°ÊúâzipÔºåÂèØËÉΩÁõ¥Êé•ÊòØÊñá‰ª∂
            Write-Host "No zip found, using downloaded files directly"
            New-Item -ItemType Directory -Path "ModLoader" -Force | Out-Null
            Copy-Item -Path "modloader-download/*" -Destination "ModLoader" -Recurse -Force
          }
          
          Write-Host "ModLoader contents:"
          Get-ChildItem -Path "ModLoader" -Recurse | Select-Object -First 30

      - name: Get ModLoader version
        id: modloader_version
        shell: bash
        run: |
          # ‰ªé dist-BeforeSC2/Utils.js ‰∏≠ÊèêÂèñÁâàÊú¨Âè∑
          UTILS_FILE=$(find ModLoader -name "Utils.js" -path "*/dist-BeforeSC2/*" | head -1)
          
          if [ -f "$UTILS_FILE" ]; then
            echo "Found Utils.js: $UTILS_FILE"
            # ÊèêÂèñ return 'xxxx'; ‰∏≠ÁöÑÁâàÊú¨Âè∑
            ML_VERSION=$(grep -oP "return\s*['\"](\d+\.\d+\.\d+)['\"]" "$UTILS_FILE" | grep -oP "\d+\.\d+\.\d+" | head -1)
            if [ -z "$ML_VERSION" ]; then
              # Â§áÈÄâÊñπÊ°àÔºöÊèêÂèñ get version() { return 'xxxx'; }
              ML_VERSION=$(grep -oP "version.*['\"](\d+\.\d+\.\d+)['\"]" "$UTILS_FILE" | grep -oP "\d+\.\d+\.\d+" | head -1)
            fi
          fi
          
          if [ -z "$ML_VERSION" ]; then
            ML_VERSION="unknown"
          fi
          
          echo "ModLoader Version: v$ML_VERSION"
          echo "MODLOADER_VERSION=v$ML_VERSION" >> $GITHUB_ENV

      - name: Copy modList.json
        shell: pwsh
        run: |
          Copy-Item "modloader/modList.json" "ModLoader/modList.json" -Force

      - name: Find and set HTML filename
        shell: bash
        run: |
          HTML_FILE=$(ls game-html/*.html | head -1)
          HTML_BASENAME=$(basename "$HTML_FILE")
          echo "HTML_FILE=$HTML_FILE" >> $GITHUB_ENV
          echo "HTML_BASENAME=$HTML_BASENAME" >> $GITHUB_ENV
          echo "Found HTML file: $HTML_FILE"

      - name: SC2 Replace
        shell: pwsh
        working-directory: ${{ github.workspace }}/ModLoader
        run: |
          $htmlPath = "${{ github.workspace }}/${{ env.HTML_FILE }}"
          $formatPath = Get-ChildItem -Path "." -Filter "format.js" -Recurse | Select-Object -First 1
          if ($formatPath) {
            Write-Host "Using format.js: $($formatPath.FullName)"
            node "dist-insertTools/sc2ReplaceTool.js" $htmlPath $formatPath.FullName
          } else {
            Write-Host "format.js not found, skipping SC2 replace"
            Copy-Item $htmlPath "$htmlPath.sc2replace.html"
          }

      - name: Inject ModLoader
        shell: pwsh
        working-directory: ${{ github.workspace }}/ModLoader
        run: |
          $htmlPath = "${{ github.workspace }}/${{ env.HTML_FILE }}.sc2replace.html"
          node "dist-insertTools/insert2html.js" $htmlPath "modList.json" "dist-BeforeSC2/BeforeSC2.js" ""

      - name: Inject ModLoader (polyfill)
        shell: pwsh
        working-directory: ${{ github.workspace }}/ModLoader
        run: |
          $htmlPath = "${{ github.workspace }}/${{ env.HTML_FILE }}.sc2replace.html"
          $polyfillPath = "dist-BeforeSC2/polyfill.js"
          if (Test-Path $polyfillPath) {
            node "dist-insertTools/insert2html-polyfill.js" $htmlPath "modList.json" "dist-BeforeSC2/BeforeSC2.js" $polyfillPath "ManualPolyfill.js"
          } else {
            Write-Host "polyfill.js not found, skipping polyfill injection"
          }

      - name: Apply CoT specific patches
        shell: bash
        run: |
          MOD_HTML="${{ env.HTML_FILE }}.sc2replace.html.mod.html"
          POLYFILL_HTML="${{ env.HTML_FILE }}.sc2replace.html.mod-polyfill.html"
          
          if [ -f "$MOD_HTML" ]; then
            python modloader/replace.py "$MOD_HTML"
          fi
          
          if [ -f "$POLYFILL_HTML" ]; then
            python modloader/replace.py "$POLYFILL_HTML"
          fi

      - name: Prepare final output
        shell: bash
        run: |
          mkdir -p final-output
          
          MOD_HTML="${{ env.HTML_FILE }}.sc2replace.html.mod.html"
          POLYFILL_HTML="${{ env.HTML_FILE }}.sc2replace.html.mod-polyfill.html"
          GAME_VER="${VERSION}"
          ML_VER="${MODLOADER_VERSION}"
          
          if [ -f "$MOD_HTML" ]; then
            cp "$MOD_HTML" "final-output/CourseOfTemptation-ModLoader-${GAME_VER}-${ML_VER}.html"
            echo "Created: CourseOfTemptation-ModLoader-${GAME_VER}-${ML_VER}.html"
          fi
          
          if [ -f "$POLYFILL_HTML" ]; then
            cp "$POLYFILL_HTML" "final-output/CourseOfTemptation-ModLoader-${GAME_VER}-${ML_VER}-polyfill.html"
            echo "Created: CourseOfTemptation-ModLoader-${GAME_VER}-${ML_VER}-polyfill.html"
          fi
          
          ls -la final-output/

      - name: Upload ModLoader injected HTML
        uses: actions/upload-artifact@v4
        with:
          name: CourseOfTemptation-ModLoader-${{ env.VERSION }}-${{ env.MODLOADER_VERSION }}
          path: final-output/*.html
          if-no-files-found: warn