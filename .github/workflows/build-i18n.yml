name: Build i18n and Package ModI18N

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 23 * * *'  # 每天北京时间 07:00 触发（UTC 23:00）

jobs:
  build_i18n:
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      PARATRANZ_TOKEN: ${{ secrets.PARATRANZ_TOKEN }}
      PYTHONIOENCODING: utf-8
    outputs:
      i18n_version: ${{ steps.detect.outputs.i18n_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install loguru ujson emoji httpx python-dotenv

      - name: Build i18n (auto detect version from Paratranz export)
        run: |
          python build.py

      - name: Detect built version
        id: detect
        shell: pwsh
        run: |
          $dir = "translated_source"
          if (!(Test-Path $dir)) { throw "translated_source not found" }
          $ver = Get-ChildItem -Path $dir -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1 -ExpandProperty Name
          echo "i18n_version=$ver" >> $env:GITHUB_OUTPUT
          Write-Host "Detected i18n version: $ver"

      - name: Upload i18n.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: i18n-${{ steps.detect.outputs.i18n_version }}
          path: translated_source\${{ steps.detect.outputs.i18n_version }}\i18n.json
          if-no-files-found: error

  package_mod:
    runs-on: windows-latest
    permissions:
      contents: write
    needs: build_i18n
    env:
      I18N_VERSION: ${{ needs.build_i18n.outputs.i18n_version }}
      CHINESE_VERSION: auto-nightly
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current date
        id: date
        shell: bash
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Download built i18n.json
        uses: actions/download-artifact@v4
        with:
          name: i18n-${{ env.I18N_VERSION }}
          path: i18n-src

      - name: Prepare version values
        shell: pwsh
        run: |
          $i18n = $env:I18N_VERSION
          $numeric = $i18n -replace '-[a-zA-Z]+$',''
          if ($i18n -match '-([a-zA-Z]+)$') { $letter = $Matches[1] } else { $letter = "" }
          if ($letter) { $withLetter = "$numeric-$letter" } else { $withLetter = $numeric }

          echo "GAME_VERSION=$numeric" >> $env:GITHUB_ENV
          echo "PKG_VER_WITH_LETTER=$withLetter" >> $env:GITHUB_ENV

          Write-Host "I18N_VERSION=$i18n"
          Write-Host "GAME_VERSION=$numeric"
          Write-Host "PKG_VER_WITH_LETTER=$withLetter"

      ##### MOD LOADER & NODEJS #####
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: Enable Corepack
        run: corepack enable

      - name: Download ModLoader Package from workflow artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: Lyoko-Jeremie/sugarcube-2-ModLoader
          workflow: Build-ModLoader-Package.yml
          workflow_conclusion: success
          name: ModLoader Package
          path: ModLoader
          search_artifacts: true

      - name: Verify ModLoader structure
        shell: pwsh
        run: |
          Write-Host "=== ModLoader contents ==="
          Get-ChildItem -Path "ModLoader" -Recurse | Select-Object -First 20 | ForEach-Object { Write-Host $_.FullName }
          
          if (!(Test-Path "ModLoader/dist-insertTools")) {
            Write-Host "ERROR: dist-insertTools not found"
            exit 1
          }
          Write-Host "✓ ModLoader structure OK"

      - name: Checkout i18nMod source
        uses: actions/checkout@v4
        with:
          repository: HCPTangHY/CoT_Mod_i18nMod
          path: ModLoader/mod/i18n
          ref: master

      - name: Build i18n Mod
        working-directory: ${{ github.workspace }}/ModLoader/mod/i18n
        shell: bash
        run: |
          echo "Installing dependencies..."
          yarn install
          echo "Building TypeScript..."
          yarn run ts:build
          echo "Building webpack..."
          yarn run build:webpack

      - name: Copy i18n.json to mod
        shell: bash
        run: |
          cp "i18n-src/i18n.json" "ModLoader/mod/i18n/i18n.json"
          echo "Copied i18n.json to ModLoader/mod/i18n/"

      - name: Change Mod Version in boot.json (Nightly)
        if: github.event_name == 'schedule'
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          if [ -f "change_mod_version.js" ]; then
            node "change_mod_version.js" "ModLoader/mod/i18n/boot.json" "$CHINESE_VERSION" "$GAME_VERSION"
          else
            echo "change_mod_version.js not found, skipping version change"
          fi

      - name: Change Mod Version in boot.json (Manually)
        if: github.event_name == 'workflow_dispatch'
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          if [ -f "change_mod_version.js" ]; then
            node "change_mod_version.js" "ModLoader/mod/i18n/boot.json" "${{ github.event.inputs.chinese_version || env.CHINESE_VERSION }}" "$GAME_VERSION"
          else
            echo "change_mod_version.js not found, skipping version change"
          fi

      - name: Build i18n Mod Package
        working-directory: ${{ github.workspace }}/ModLoader/mod/i18n
        shell: bash
        run: |
          node "${{ github.workspace }}/ModLoader/dist-insertTools/packModZip.js" "boot.json"

      - name: Rename i18n Mod for upload (Nightly)
        if: github.event_name == 'schedule'
        shell: bash
        run: |
          mv "ModLoader/mod/i18n/ModI18N.mod.zip" "ModLoader/mod/i18n/ModI18N-$GAME_VERSION-chs-$CHINESE_VERSION.mod.zip"

      - name: Rename i18n Mod for upload (Manually)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          CHINESE_VER="${{ github.event.inputs.chinese_version || env.CHINESE_VERSION }}"
          mv "ModLoader/mod/i18n/ModI18N.mod.zip" "ModLoader/mod/i18n/ModI18N-$GAME_VERSION-chs-$CHINESE_VER.mod.zip"

      - name: Upload ModI18N zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: ModI18N-${{ env.I18N_VERSION }}
          path: ModLoader/mod/i18n/ModI18N*.mod.zip
          if-no-files-found: error

      - name: Release i18n Mod (Nightly)
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'schedule'
        with:
          files: ModLoader/mod/i18n/ModI18N-${{ env.GAME_VERSION }}-chs-${{ env.CHINESE_VERSION }}.mod.zip
          name: Auto Release nightly v${{ env.GAME_VERSION }}-chs-${{ env.CHINESE_VERSION }}-auto-${{ steps.date.outputs.date }}
          tag_name: ${{ env.GAME_VERSION }}-chs-${{ env.CHINESE_VERSION }}-auto-${{ steps.date.outputs.date }}-${{ github.sha }}
          body: Scheduled task on ${{ steps.date.outputs.date }}
          prerelease: true

      - name: Release i18n Mod (Manually)
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch'
        with:
          files: ModLoader/mod/i18n/ModI18N-${{ env.GAME_VERSION }}-chs-${{ github.event.inputs.chinese_version || env.CHINESE_VERSION }}.mod.zip
          name: Release v${{ env.GAME_VERSION }}-chs-${{ github.event.inputs.chinese_version || env.CHINESE_VERSION }}
          tag_name: ${{ env.GAME_VERSION }}-chs-${{ github.event.inputs.chinese_version || env.CHINESE_VERSION }}-${{ github.sha }}
          body: release v${{ env.GAME_VERSION }}-chs-${{ github.event.inputs.chinese_version || env.CHINESE_VERSION }}